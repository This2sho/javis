<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>문제 JSON 업로드</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>

<h1>문제 JSON 업로드</h1>

<!-- 1️⃣ JSON 파일 선택 -->
<input type="file" id="jsonFileInput" accept=".json"/>

<!-- 2️⃣ JSON 미리보기 -->
<textarea id="jsonPreview" placeholder="JSON 내용이 여기에 표시됩니다"></textarea>

<!-- 3️⃣ 서버 전송 버튼 -->
<br/>
<button onclick="submitProblems()">서버로 문제 등록</button>

<!-- 4️⃣ 결과 표시 -->
<div id="status" class="status"></div>

<script>
    const fileInput = document.getElementById("jsonFileInput");
    const preview = document.getElementById("jsonPreview");
    const status = document.getElementById("status");

    let parsedJson = null;

    /* ===============================
       JSON 파일 읽기
    =============================== */
    fileInput.addEventListener("change", () => {
        const file = fileInput.files[0];
        if (!file) return;

        const reader = new FileReader();

        reader.onload = (e) => {
            try {
                parsedJson = JSON.parse(e.target.result);
                preview.value = JSON.stringify(parsedJson, null, 2);
                status.textContent = "JSON 파일 로드 성공";
                status.style.color = "green";
            } catch (error) {
                status.textContent = "JSON 파싱 실패";
                status.style.color = "red";
                parsedJson = null;
            }
        };

        reader.readAsText(file);
    });

    /* ===============================
       서버로 POST 요청
    =============================== */
    async function submitProblems() {
        if (!parsedJson) {
            alert("유효한 JSON 파일을 먼저 업로드하세요.");
            return;
        }
        fetch("/admin/api/problems", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(parsedJson)
        })
        .then(res => {
            const location = res.headers.get("Location");
            if (location) {
                window.location.href = location;
                return;
            }

            // 2️⃣ body 기반 redirect (선택)
            return res.json();
        })
        .then(data => {
            if (data && data.redirectUrl) {
                window.location.href = data.redirectUrl;
            }
        })
        .catch(err => {
            console.error(err);
            status.textContent = "문제 등록 실패";
            status.style.color = "red";
            alert("처리 중 오류가 발생했습니다.");
        });
    }
</script>

</body>
</html>
