<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${interviewTitle}">ì¸í„°ë·°</title>
    <link rel="stylesheet" href="/css/chat.css">
</head>
<body>

<h2 th:text="${interviewTitle}"></h2>

<input type="hidden" th:value="${mainCategory}" id="mainCategory">
<input type="hidden" value="-1" id="questionId"/>

<div class="chat-container">
    <div class="messages" id="chatContainer">

        <!-- âœ… ì‹œì‘ ì¸ì‚¬ (SSR) -->
        <div class="message bot-message"
             th:text="${welcomeMessage}">
        </div>

    </div>

    <div class="input-container">
        <textarea id="chatInput"
                  class="chat-input"
                  placeholder="ë‹µë³€ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>

        <button class="send-button" id="sendButton">
            <svg viewBox="0 0 24 24">
                <path d="M2 21l21-9L2 3v7l15 2-15 2v7z"/>
            </svg>
        </button>
    </div>
</div>

<script>
    const chatInput = document.getElementById("chatInput");
    const chatContainer = document.getElementById("chatContainer");
    const sendButton = document.getElementById("sendButton");

    const mainCategory = document.getElementById("mainCategory").value;

    /* =========================
       í˜ì´ì§€ ë¡œë“œ â†’ ì¦‰ì‹œ ì‹œì‘
    ========================= */
    document.addEventListener("DOMContentLoaded", () => {
        startInterview();
    });

    function startInterview() {
        lockInput();

        fetch(`/api/interviews/start/${mainCategory}`, {
            method: "GET",
            credentials: "include"
        })
            .then(res => res.json())
            .then(data => {
                if (!data.isFirst) {
                    appendBotMessage("ì§„í–‰ì¤‘ì´ë˜ ì¸í„°ë·°ë¥¼ ì´ì–´ì„œ ì§„í–‰í•©ë‹ˆë‹¤.");
                }
                appendBotMessage(data.question);
                questionIdInput = document.getElementById("questionId");
                questionIdInput.value = data.questionId;
                unlockInput();
            })
            .catch(err => {
                console.error(err);
                appendBotMessage("âš ï¸ ì¸í„°ë·°ë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                unlockInput();
            });
    }

    /* =========================
       ë©”ì‹œì§€ ì „ì†¡
    ========================= */
    function sendMessage() {
        let userAnswer = chatInput.value.replace(/\n+$/, "");
        questionId = document.getElementById("questionId").value;
        if (!userAnswer.trim()) return;

        const latestQuestion =
            chatContainer.querySelector(".bot-message:last-child")?.innerText;

        appendUserMessage(userAnswer);
        resetInput();
        lockInput();

        const loadingMessage = appendLoadingMessage();

        fetch(`/api/questions/${questionId}/answer`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify({
                problem: latestQuestion,
                userAnswer: userAnswer
            })
        })
            .then(res => res.json())
            .then(data => {
                loadingMessage.remove();

                if (data.ended) {
                    appendBotMessage("ì¸í„°ë·°ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ìˆ˜ê³ í•˜ì…¨ìŠµë‹ˆë‹¤! ğŸ‰");
                    setTimeout(() => {
                        window.location.href = `/interviews/${data.interviewId}`;
                    }, 1500);
                } else {
                    appendBotMessage(data.interviewerMessage);
                    questionIdInput.value = data.questionId;
                    unlockInput();
                }
            })
            .catch(err => {
                loadingMessage.remove();
                console.error(err);
                appendBotMessage("âš ï¸ ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                unlockInput();
            });
    }

    /* =========================
       UI í—¬í¼
    ========================= */
    function appendBotMessage(text) {
        const div = document.createElement("div");
        div.className = "message bot-message";
        div.innerText = text;
        chatContainer.appendChild(div);
        scrollBottom();
    }

    function appendUserMessage(text) {
        const div = document.createElement("div");
        div.className = "message user-message";
        div.innerText = text;
        chatContainer.appendChild(div);
        scrollBottom();
    }

    function appendLoadingMessage() {
        const div = document.createElement("div");
        div.className = "message bot-message loading";

        const spinner = document.createElement("div");
        spinner.className = "spinner";

        const text = document.createElement("span");
        text.innerText = "ë‹µë³€ì„ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤";

        div.appendChild(spinner);
        div.appendChild(text);
        chatContainer.appendChild(div);
        scrollBottom();
        return div;
    }

    function resetInput() {
        chatInput.value = "";
        chatInput.style.height = "40px";
    }

    function lockInput() {
        chatInput.disabled = true;
        sendButton.disabled = true;
    }

    function unlockInput() {
        chatInput.disabled = false;
        sendButton.disabled = false;
        chatInput.focus();
    }

    function scrollBottom() {
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    /* =========================
       ì´ë²¤íŠ¸
    ========================= */
    chatInput.addEventListener("input", () => {
        chatInput.style.height = "auto";
        chatInput.style.height = Math.min(chatInput.scrollHeight, 150) + "px";
    });

    chatInput.addEventListener("keydown", e => {
        if (e.key === "Enter" && !e.shiftKey && !e.isComposing) {
            e.preventDefault();
            sendMessage();
        }
    });

    sendButton.addEventListener("click", sendMessage);
</script>

</body>
</html>
