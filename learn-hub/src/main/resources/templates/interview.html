<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${interviewTitle}">인터뷰</title>
    <link rel="stylesheet" href="/css/chat.css">
</head>
<body>

<h2 th:text="${interviewTitle}"></h2>

<input type="hidden" th:value="${mainCategory}" id="mainCategory">
<input type="hidden" value="-1" id="questionId"/>

<div class="chat-container">
    <div class="messages" id="chatContainer">

        <!-- ✅ 시작 인사 (SSR) -->
        <div class="message bot-message"
             th:text="${welcomeMessage}">
        </div>

    </div>

    <div class="input-container">
        <textarea id="chatInput"
                  class="chat-input"
                  placeholder="답변을 입력하세요..."></textarea>

        <button class="send-button" id="sendButton">
            <svg viewBox="0 0 24 24">
                <path d="M2 21l21-9L2 3v7l15 2-15 2v7z"/>
            </svg>
        </button>
    </div>
</div>

<script>
    const chatInput = document.getElementById("chatInput");
    const chatContainer = document.getElementById("chatContainer");
    const sendButton = document.getElementById("sendButton");
    const mainCategory = document.getElementById("mainCategory").value;

    let ws = null;
    let loadingMessage = null;
    let memberId = null;

    /* =========================
       페이지 로드 → WebSocket 연결 + 인터뷰 시작
    ========================= */
    document.addEventListener("DOMContentLoaded", () => {
        startInterview();
    });

    function startInterview() {
        lockInput();

        fetch(`/api/interviews/start/${mainCategory}`, {
            method: "GET",
            credentials: "include"
        })
            .then(res => res.json())
            .then(data => {
                connectWebSocket(data.interviewId);

                if (!data.isFirst) {
                    appendBotMessage("진행중이던 인터뷰를 이어서 진행합니다.");
                }
                if (data.isPendingEvaluation) {
                    appendBotMessage("이전 답변을 채점 중입니다. 잠시만 기다려주세요.");
                    loadingMessage = appendLoadingMessage();
                    return;
                }
                appendBotMessage(data.question);
                document.getElementById("questionId").value = data.questionId;
                unlockInput();
            })
            .catch(err => {
                console.error(err);
                appendBotMessage("인터뷰를 시작할 수 없습니다.");
                unlockInput();
            });
    }

    /* =========================
       WebSocket 연결
    ========================= */
    function connectWebSocket(interviewId) {
        const wsProtocol = window.location.protocol === "https:" ? "wss:" : "ws:";
        const wsUrl = `${wsProtocol}//${window.location.host}/ws/interview`;

        ws = new WebSocket(wsUrl);

        ws.onopen = () => {
            console.log("WebSocket 연결 성공");
        };

        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            handleNextQuestion(data);
        };

        ws.onclose = () => {
            console.log("WebSocket 연결 종료");
            setTimeout(() => {
                if (interviewId) connectWebSocket(interviewId);
            }, 3000);
        };

        ws.onerror = (error) => {
            console.error("WebSocket 에러:", error);
        };
    }

    /* =========================
       다음 질문 수신 처리
    ========================= */
    function handleNextQuestion(data) {
        if (loadingMessage) {
            loadingMessage.remove();
            loadingMessage = null;
        }

        if (data.ended) {
            appendBotMessage("인터뷰가 종료되었습니다. 수고하셨습니다!");
            setTimeout(() => {
                window.location.href = `/interviews/${data.interviewId}`;
            }, 1500);
        } else {
            appendBotMessage(data.interviewerMessage);
            document.getElementById("questionId").value = data.questionId;
            unlockInput();
        }
    }

    /* =========================
       답변 전송 (비동기)
    ========================= */
    function sendMessage() {
        let userAnswer = chatInput.value.replace(/\n+$/, "");
        const questionId = document.getElementById("questionId").value;
        if (!userAnswer.trim()) return;

        const latestQuestion =
            chatContainer.querySelector(".bot-message:last-child")?.innerText;

        appendUserMessage(userAnswer);
        resetInput();
        lockInput();

        loadingMessage = appendLoadingMessage();

        fetch(`/api/questions/${questionId}/answer`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify({
                problem: latestQuestion,
                userAnswer: userAnswer
            })
        })
            .then(res => {
                if (res.status === 202) {
                    console.log("답변 제출 완료, 채점 대기 중...");
                } else {
                    throw new Error("답변 제출 실패");
                }
            })
            .catch(err => {
                if (loadingMessage) {
                    loadingMessage.remove();
                    loadingMessage = null;
                }
                console.error(err);
                appendBotMessage("서버 오류가 발생했습니다.");
                unlockInput();
            });
    }

    /* =========================
       UI 헬퍼
    ========================= */
    function appendBotMessage(text) {
        const div = document.createElement("div");
        div.className = "message bot-message";
        div.innerText = text;
        chatContainer.appendChild(div);
        scrollBottom();
    }

    function appendUserMessage(text) {
        const div = document.createElement("div");
        div.className = "message user-message";
        div.innerText = text;
        chatContainer.appendChild(div);
        scrollBottom();
    }

    function appendLoadingMessage() {
        const div = document.createElement("div");
        div.className = "message bot-message loading";

        const spinner = document.createElement("div");
        spinner.className = "spinner";

        const text = document.createElement("span");
        text.innerText = "답변을 분석 중입니다";

        div.appendChild(spinner);
        div.appendChild(text);
        chatContainer.appendChild(div);
        scrollBottom();
        return div;
    }

    function resetInput() {
        chatInput.value = "";
        chatInput.style.height = "40px";
    }

    function lockInput() {
        chatInput.disabled = true;
        sendButton.disabled = true;
    }

    function unlockInput() {
        chatInput.disabled = false;
        sendButton.disabled = false;
        chatInput.focus();
    }

    function scrollBottom() {
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    /* =========================
       이벤트
    ========================= */
    chatInput.addEventListener("input", () => {
        chatInput.style.height = "auto";
        chatInput.style.height = Math.min(chatInput.scrollHeight, 150) + "px";
    });

    chatInput.addEventListener("keydown", e => {
        if (e.key === "Enter" && !e.shiftKey && !e.isComposing) {
            e.preventDefault();
            sendMessage();
        }
    });

    sendButton.addEventListener("click", sendMessage);

    window.addEventListener("beforeunload", () => {
        if (ws) ws.close();
    });
</script>

</body>
</html>
