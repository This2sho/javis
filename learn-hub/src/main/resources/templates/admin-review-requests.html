<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë¦¬ë·° ìš”ì²­ ëª©ë¡</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>

<header>
    <h1>ë¦¬ë·° ìš”ì²­ ëª©ë¡</h1>

    <div style="margin-top:12px;">
        <select id="status-select">
            <option value="PENDING_REVIEW" selected>ëŒ€ê¸°ì¤‘</option>
            <option value="APPROVED">ìŠ¹ì¸ë¨</option>
            <option value="REJECTED">ê±°ì ˆë¨</option>
        </select>
    </div>
</header>

<main class="page-container">
    <div id="review-list" class="problem-list"></div>
</main>

<script src="/js/cursor-paging.js"></script>
<script>

    const list = document.getElementById("review-list");

    let cursor = null;     // CursorResponse
    let hasNext = true;
    let currentStatus = "PENDING_REVIEW";

    const statusSelect = document.getElementById("status-select");

    statusSelect.addEventListener("change", () => {
        currentStatus = statusSelect.value;

        // ğŸ”¥ ìƒíƒœ ë°”ë€Œë©´ ì „ë¶€ ì´ˆê¸°í™”
        cursor = null;
        hasNext = true;
        list.innerHTML = "";

        loadReviews();
    });

    /* ===============================
       ë°ì´í„° ë¡œë”©
    =============================== */
    async function loadReviews() {
        if (!hasNext) return;

        try {
            const page = await fetchCursorPage({
                url: "/admin/api/review-requests",
                params: {
                    registrationStatus: currentStatus
                },
                cursor
            });

            renderReviews(page.items);

            cursor = page.nextCursor;   // ğŸ”¥ ì„œë²„ê°€ ë‚´ë ¤ì¤€ ì»¤ì„œ ê·¸ëŒ€ë¡œ ì‚¬ìš©
            hasNext = page.hasNext;

        } catch (e) {
            console.error(e);
            alert("ë¦¬ë·° ìš”ì²­ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
        }
    }

    /* ===============================
       ë Œë”ë§
    =============================== */
    function renderReviews(reviews) {
        if (!reviews || reviews.length === 0) {
            // ìµœì´ˆ ë¡œë”©ì¸ë° ì•„ë¬´ê²ƒë„ ì—†ì„ ë•Œë§Œ ë©”ì‹œì§€
            if (list.children.length === 0) {
                list.innerHTML =
                    `<p style="text-align:center;">ë¦¬ë·° ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
            }
            return;
        }

        reviews.forEach(r => {
            const card = document.createElement("div");
            card.className = "problem-card";

            // í´ë¦­ â†’ ë¬¸ì œ ìƒì„¸
            card.onclick = () => {
                location.href = `/admin/review-requests/${r.id}`;
            };

            card.innerHTML = `
                <div class="problem-content">
                    ${r.rootProblem}
                </div>
                <div class="problem-meta">
                    <span class="tag review-status">${r.registrationStatus}</span>
                </div>
            `;

            list.appendChild(card);
        });
    }

    /* ===============================
       ë¬´í•œ ìŠ¤í¬ë¡¤
    =============================== */
    window.addEventListener("scroll", () => {
        if (
            window.innerHeight + window.scrollY >=
            document.body.offsetHeight - 200
        ) {
            loadReviews();
        }
    });

    /* ===============================
       ìµœì´ˆ ë¡œë”©
    =============================== */
    loadReviews();
</script>

</body>
</html>
