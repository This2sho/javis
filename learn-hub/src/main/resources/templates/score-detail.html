<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>카테고리 점수 상세</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>

<header>
    <h1 id="pageTitle">카테고리 점수</h1>
    <button onclick="goBack()">뒤로</button>
</header>

<input type="hidden" th:value="${mainCategory}" id="mainCategory">

<main class="chart-container">
    <div class="chart-title" id="chartTitle"></div>
    <div id="chart"></div>
</main>

<script>
    let rootNode = null;
    let nodeStack = []; // 드릴다운 스택
    const mainCategory = document.getElementById("mainCategory").value;

    document.addEventListener("DOMContentLoaded", () => {
        loadScoreTree();
    });

    /* =========================
       API 호출
    ========================= */
    function loadScoreTree() {
        fetch(`/api/scores/${mainCategory}`, {
            method: "GET",
            credentials: "include"
        })
            .then(res => res.json())
            .then(data => {
                rootNode = data;          // MainCategory 노드
                nodeStack = [rootNode];  // 스택 초기화
                renderCurrentLevel();
            })
            .catch(() => alert("점수 정보를 불러오지 못했습니다."));
    }

    /* =========================
       렌더링
    ========================= */
    function renderCurrentLevel() {
        const currentNode = nodeStack[nodeStack.length - 1];
        const children = currentNode.children;

        // ✅ categoryName 그대로 사용
        document.getElementById("chartTitle").innerText =
            `${currentNode.categoryName} 점수`;

        const chart = document.getElementById("chart");
        chart.innerHTML = "";

        if (!children || children.length === 0) {
            chart.innerHTML = "<p>하위 카테고리가 없습니다.</p>";
            return;
        }

        const maxScore = Math.max(...children.map(c => c.score), 1);

        children.forEach(child => {
            const row = document.createElement("div");
            row.className = "bar-row";

            // children 있으면 드릴다운 가능
            if (child.children && child.children.length > 0) {
                row.style.cursor = "pointer";
                row.addEventListener("click", () => {
                    nodeStack.push(child);
                    renderCurrentLevel();
                });
            }

            const label = document.createElement("div");
            label.className = "bar-label";
            label.innerText = child.categoryName; // ✅ 그대로 사용

            const wrapper = document.createElement("div");
            wrapper.className = "bar-wrapper";

            const bar = document.createElement("div");
            bar.className = "bar";
            bar.style.width = (child.score / maxScore * 100) + "%";

            const score = document.createElement("div");
            score.className = "bar-score";
            score.innerText = child.score + "점";

            wrapper.appendChild(bar);
            row.appendChild(label);
            row.appendChild(wrapper);
            row.appendChild(score);
            chart.appendChild(row);
        });
    }

    /* =========================
       네비게이션
    ========================= */
    function goBack() {
        if (nodeStack.length > 1) {
            nodeStack.pop();
            renderCurrentLevel();
        } else {
            history.back();
        }
    }
</script>

</body>
</html>
