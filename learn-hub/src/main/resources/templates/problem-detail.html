<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Î¨∏Ï†ú ÏÉÅÏÑ∏</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>

<header>
    <h1>Î¨∏Ï†ú ÏÉÅÏÑ∏</h1>
</header>

<main class="page-container">

    <!-- ÏùΩÍ∏∞ Î™®Îìú -->
    <div id="view-root"></div>

    <div class="page-actions">
        <button class="primary-action" onclick="requestReview()">Î¶¨Î∑∞ÏöîÏ≤≠</button>
        <button class="primary-action" onclick="enterEditModeAll()">ÏàòÏ†ïÌïòÍ∏∞</button>
    </div>

    <!-- Ìé∏Ïßë Î™®Îìú -->
    <div id="edit-mode" style="display:none;">
        <h2>Î¨∏Ï†ú Ìé∏Ïßë</h2>
        <div id="edit-root"></div>

        <div class="edit-actions">
            <button class="submit-btn" onclick="submitUpdate()">ÏàòÏ†ï ÏôÑÎ£å</button>
            <button class="secondary-btn" onclick="exitEditMode()">Ï∑®ÏÜå</button>
        </div>
    </div>

</main>

<script th:inline="javascript">
    const ROOT_PROBLEM_ID = /*[[${problemId}]]*/ 0;
    const DIFFICULTIES = /*[[${difficulties}]]*/ [];
    const CATEGORY_TREE = /*[[${categoryTree.categoryNodeResponses}]]*/ [];
</script>

<script src="/js/problem-form.js"></script>

<script>
    let ROOT_RESPONSE = null;

    /* ===============================
       ÌÇ§ÏõåÎìú
    =============================== */
    function addKeywordByValue(node, value) {
        let list = node.querySelector(".keyword-list");
        if (!list) {
            list = document.createElement("div");
            list.className = "keyword-list";
            node.appendChild(list);
        }
        if ([...list.children].some(el => el.innerText === value)) return;

        const span = document.createElement("span");
        span.className = "keyword-tag";
        span.innerText = value;
        list.appendChild(span);
    }

    /* ===============================
       ÏÉÅÏÑ∏ Ï°∞Ìöå
    =============================== */
    fetch(`/api/problems/${ROOT_PROBLEM_ID}`, { credentials: "include" })
        .then(res => res.json())
        .then(problem => {
            ROOT_RESPONSE = problem;
            const root = document.getElementById("view-root");
            root.innerHTML = "";
            renderView(root, problem, 0);
        });

    function renderView(container, problem, depth) {
        const box = document.createElement("div");
        box.className = "problem-box";
        box.style.marginLeft = `${depth * 24}px`;

        box.innerHTML = `
            <div class="problem-content">${problem.content}</div>
            <div class="problem-meta">
                <span class="tag difficulty">${problem.difficulty}</span>
                <span class="tag category">${problem.category}</span>
            </div>
            <div class="section">
                <h4>ÏòàÏÉÅ ÎãµÎ≥Ä</h4>
                <p>${problem.referenceAnswer}</p>
            </div>
            <div class="section keyword-list"></div>
        `;

        const kw = box.querySelector(".keyword-list");
        problem.keywords?.forEach(k => {
            const span = document.createElement("span");
            span.className = "keyword-tag";
            span.innerText = k;
            kw.appendChild(span);
        });

        container.appendChild(box);
        problem.followUps?.forEach(fu => renderView(container, fu, depth + 1));
    }

    /* ===============================
       ÏàòÏ†ï Î™®Îìú
    =============================== */
    function enterEditModeAll() {
        document.getElementById("view-root").style.display = "none";
        document.querySelector(".page-actions").style.display = "none";
        document.getElementById("edit-mode").style.display = "block";

        const editRoot = document.getElementById("edit-root");
        editRoot.innerHTML = "";

        const rootNode = createProblemNode(ROOT_RESPONSE.category);
        rootNode.dataset.root = "true"; // üî• Î£®Ìä∏ ÌëúÏãú
        ensureHiddenId(rootNode);

        editRoot.appendChild(rootNode);
        fillEditTree(rootNode, ROOT_RESPONSE);
    }

    function fillEditTree(node, problem) {
        node.dataset.problemId = problem.id; // üî• Ïó¨Í∏∞

        node.querySelector('[data-field="content"]').value = problem.content;
        node.querySelector('[data-field="expectedAnswer"]').value = problem.referenceAnswer;
        node.querySelector('[data-field="difficulty"]').value = problem.difficulty;
        node.querySelector('[data-field="category"]').value = problem.category;

        selectDifficulty(node, problem.difficulty);
        problem.keywords?.forEach(k => addKeywordByValue(node, k));

        if (!problem.followUps) return;

        const children = node.querySelector(":scope > .children");
        problem.followUps.forEach(fu => {
            const child = createProblemNode(fu.category);
            children.appendChild(child);
            fillEditTree(child, fu);
        });
    }


    function ensureHiddenId(node) {
        if (!node.querySelector('[data-field="id"]')) {
            const input = document.createElement("input");
            input.type = "hidden";
            input.setAttribute("data-field", "id");
            node.appendChild(input);
        }
    }

    function selectDifficulty(node, difficulty) {
        node.querySelectorAll(".difficulty-btn").forEach(btn => {
            btn.classList.toggle("selected", btn.innerText === difficulty);
        });
        node.querySelector('[data-field="difficulty"]').value = difficulty;
    }

    function exitEditMode() {
        document.getElementById("edit-mode").style.display = "none";
        document.getElementById("view-root").style.display = "block";
        document.querySelector(".page-actions").style.display = "block";
        document.getElementById("edit-root").innerHTML = "";
    }

    function submitUpdate() {
        const rootBox = document.querySelector(
            '#edit-root > .problem-box[data-root="true"]'
        );

        const payload = collectProblemNode(rootBox);

        fetch(`/api/problems/${ROOT_PROBLEM_ID}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify(payload)
        }).then(res => {
            if (!res.ok) throw new Error("ÏàòÏ†ï Ïã§Ìå®");
            location.reload();
        });
    }

    function requestReview() {
        fetch(`/api/problems/${ROOT_PROBLEM_ID}/review-requests`, {
            method: "POST",
            credentials: "include"
        }).then(res => {
            const location = res.headers.get("Location");
            if (location) window.location.href = location;
        });
    }
</script>

</body>
</html>
